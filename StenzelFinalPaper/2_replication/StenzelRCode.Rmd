---
title: "On Using the Metropolis-Hastings Algorithm for Data Imputation"
author: "Tobias Stenzel"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
   - \usepackage{tikz, float, caption, amsthm, algorithm, algpseudocode}
   - \floatplacement{figure}{H}
   #- \newtheorem{definition}{Definition}
   - \interfootnotelinepenalty=10000 # no multi-page footnotes
output:
  bookdown::pdf_document2:
    template: template.tex
    latex_engine: xelatex
    toc: yes
    toc_depth: 2
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
bibliography: bibliography.bib
csl-hanging-indent: yes
fontsize: 12pt 
linestretch: 2.0 # adjust for line spacing 
geometry: left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm
classoption:
- a4paper
- oneside
lang: en-EN
numbersections: yes
csquotes: yes
type: Final Paper for Course
course: Advanced Quantitative Methods in Political Science
subtitle: ''
address: ''
email: tobias.stenzel@students.uni-mannheim.de
phone: ''
examiner: Prof. Thomas Gschwend, Ph.D.
chair: ''
mp: 0.55
ID: ''
# STRONGLY BIASED wordcount: '*Wordcount excluding References: `r unima::count_words(knitr::current_input())`*' 
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/american-political-science-association.csl
editor_options:
  markdown:
    wrap: sentence
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      include=FALSE,
                      fig.path = "figs/",
                      out.width="\\textwidth"
                      )

p_needed <- c(# all packages you need to install here
  "knitr",
  "bookdown", # referencing figures and tables by label
  "remotes",
  "ggplot2",
  "stargazer",
  "dplyr", # to compute leads values
  "tidyr", # for dropping nans
  "GGally", # correlation matrix style plots
  "gridExtra", # grid for multiple plots
  "cowplot",
  "MASS", # glm
  "janitor", # fd plot over range
  #"countreg", # rootogram
  "ggeasy", # remove axes
  "latex2exp", # latex legend labels
  "ggridges",
  #christopher claassen's additional requirements
  "arm",
  "loo",
  "rstan",
  "RColorBrewer"
  )


# installs only the required packages 
lapply(p_needed[!(p_needed %in% rownames(installed.packages()))], install.packages)
lapply(p_needed, library, character.only = TRUE)

# separately install for the correct wordcount package 
if (!"unima" %in% rownames(installed.packages())){
  remotes::install_github("vktrsmnv/unima-template", upgrade = "never", dependencies = TRUE)
  }

# this allows you to add notes to figures with a simple chunk option
# you only need to add "notes="text" as a chunk option; 
# the notes will only appear in PDF output
hook_chunk = knit_hooks$get('chunk')
knit_hooks$set(chunk = function(x, options) {
  txt = hook_chunk(x, options)
  # add chunk option 'description' which adds \Description{...} to figures
  if (!is.null(options$notes)) {
    latex_include <- paste0("\\\\vspace\\{0.5cm\\} \\\\\\footnotesize\\{\\\\textit\\{Notes: \\}", options$notes, "\\} \\1")
    gsub('(\\\\end\\{figure\\})', latex_include, txt) 
  } else {
    return(txt)  # pass to default hook
  }
})
if (knitr::is_latex_output()) knitr::knit_hooks$set(plot = knitr::hook_plot_tex)

# This is an option for stargazer tables
# It automatically adapts the output to html or latex,
# depending on whether we want a html or pdf file
stargazer_opt <- ifelse(knitr::is_latex_output(), "latex", "html")

# This ensures that if the file is knitted to HTML,
# significance notes are depicted correctly 
if (stargazer_opt == "html"){
  fargs <- formals(stargazer)
  fargs$notes.append = FALSE
  fargs$notes = c("<em>&#42;p&lt;0.1;&#42;&#42;p&lt;0.05;&#42;&#42;&#42;p&lt;0.01</em>")
  formals(stargazer) <- fargs
}

# only relevant for ggplot2 plotting
# setting a global ggplot theme for the entire document to avoid 
# setting this individually for each plot 
theme_set(theme_classic() + # start with classic theme 
  theme(
    plot.background = element_blank(),# remove all background 
    plot.title.position = "plot", # move the plot title start slightly 
    legend.position = "bottom" # by default, put legend on the bottom
  ))

set.seed(2022)
```

```{r configs}
# folders
WD = rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(WD))
print( getwd() )
```

# 02 Literature Review and Data

```{r load-data}
# read support for dem data. NOTE: We have RespN instead of RespPerc as in online material
df = read.csv("raw-data/supdem raw survey marginals.csv")
```

```{r data-processing}
# remove NAs
df = df[!df$Response==0, ]

# create year by country indicators
year0 = 1987
df = df[df$Year > year0,]
df = unite(df, YearCountry, c(Year, Country), sep = "_", remove = FALSE)

# create item by country indicators
df = unite(df, ItemCnt, c(Item, Country), sep = "_", remove = FALSE)

# create year by project indicators
df = unite(df, YrProj, c(Year, Project), sep = "_", remove = FALSE)

# create year by project by country indicators
df = unite(df, YrProjCnt, c(YrProj, Country), sep = "_", remove = FALSE)


# factorise
df$Country = as.factor(as.character(df$Country))
df$Item = as.factor(as.character(df$Item))
df$ItemCnt = as.factor(as.character(df$ItemCnt))
df$Project = as.factor(as.character(df$Project))
df$YrProj = as.factor(as.character(df$YrProj))
df$YrProjCnt = as.factor(as.character(df$YrProjCnt))
df$Year = df$Year-year0

# count data
dim(df)[1]                   # 3765 national responses
length(unique(df$Country))   # 150 countries
length(unique(df$Project))   # 14 projects
length(unique(df$Item))      # 52 items
length(unique(df$ItemCnt))   # 1453 item-country
length(unique(df$YrProjCnt)) # 1390 national surveys
length(unique(df$Year))      # 27 unique years (out of 30)
sum(df$Sample) / dim(df)[1] * length(unique(df$YrProjCnt))   # 1,804,450 respondents              
```
```{r analyze-years-coverage}
# drop countries with less than 2 years of data
cnt.obs.years = rowSums(table(df$Country, df$Year) > 0)
sort(cnt.obs.years)
mean(cnt.obs.years)
```
```{r drop-countries-with-only-1-year-of-survey-measures}
df2 = df[df$Country %in% levels(df$Country)[cnt.obs.years > 1], ]
length(unique(df2$Country))   # 137 countries with 2+ years of data
```



```{r get-topk-data-countries-number-of-respondants}
sums_respondants_by_country = df2 %>%
    group_by(Country) %>%
    summarize(Sum_Sample = sum(Sample))

topk_sum_respondants = tbl_df(sums_respondants_by_country) %>%
  arrange(sums_respondants_by_country) %>%
  top_n(1)

cond <- unique(topk_sum_respondants$Country)
unique(topk_sum_respondants$Country)

# show data of China as example
filter(df2, Country %in% cond) 
```



```{r figure-sparse-data}

## Plot indicative grid showing data availability (figure 1)

# plot 1: all items

#pdf("figure1.pdf", width=6.5, height=3.5)
layout(matrix(1:4, nrow=2, ncol=2, byrow=TRUE), widths=c(1.4, 1), heights=c(1, 1.15))

plot.cnt.2 = c('Egypt', 'Venezuela', 'South Africa', 'Botswana', 'China', 'Ukraine', 
               'United States of America', 'Sweden')

plot.dat.2 = df2[df2$Country %in% plot.cnt.2,]
cnt.yr.tab = table(df2$Year, df2$Country)
cnt.yr.tab = ifelse(cnt.yr.tab > 0, 1, NA)
plot.dat.2 = rbind(cnt.yr.tab[,plot.cnt.2[1]], cnt.yr.tab[,plot.cnt.2[2]], cnt.yr.tab[,plot.cnt.2[3]],
                   cnt.yr.tab[,plot.cnt.2[4]], cnt.yr.tab[,plot.cnt.2[5]], cnt.yr.tab[,plot.cnt.2[6]],
                   cnt.yr.tab[,plot.cnt.2[7]], cnt.yr.tab[,plot.cnt.2[8]])
plot.dat.2 = plot.dat.2 * 1:8

par(mar=c(0.3, 7.5, 2, 0.5), tcl=-0.2, cex=0.8)
plot(plot.dat.2[1,], type="n", ylim=c(0.5, 8.5), xaxt="n", yaxt="n", xlab="", ylab="", 
     main='', xlim=c(1, 27), bty="n")
abline(h=1:8, col=grey(0.5), lwd=0.75, lty=3)
abline(v=1:28, col=grey(0.5), lwd=0.75, lty=3)
for(i in 1:8){
  points(plot.dat.2[i,], pch=16, cex=1.1, col='black')
}
axis(2, at=1:8, labels=plot.cnt.2, cex.axis=0.78, mgp=c(1, .5, 0), las=1)
mtext(text='All items', side=3, line=0.4, cex=0.85)
box(lwd=0.75)

# plot 2: only strongman item
cnt.yr.tab = table(df2[grep('Strong', df2$Item), "Year"], 
                   df2[grep('Strong', df2$Item), "Country"])
cnt.yr.tab = ifelse(cnt.yr.tab > 0, 1, NA)
plot.dat.2 = rbind(cnt.yr.tab[,plot.cnt.2[1]], cnt.yr.tab[,plot.cnt.2[2]], cnt.yr.tab[,plot.cnt.2[3]],
                   cnt.yr.tab[,plot.cnt.2[4]], cnt.yr.tab[,plot.cnt.2[5]], cnt.yr.tab[,plot.cnt.2[6]],
                   cnt.yr.tab[,plot.cnt.2[7]], cnt.yr.tab[,plot.cnt.2[8]])
plot.dat.2 = plot.dat.2 * 1:8

par(mar=c(0.3, 0.5, 2, 0.5), tcl=-0.2, cex=0.8)
plot(plot.dat.2[1,], type="p", ylim=c(0.5, 8.5), xaxt="n", yaxt="n", xlab="", ylab="", 
     main='', xlim=c(1, 27), bty="n")
abline(h=1:8, col=grey(0.5), lwd=0.75, lty=3)
abline(v=1:28, col=grey(0.5), lwd=0.75, lty=3)
for(i in 1:8){
  points(plot.dat.2[i,], pch=16, cex=1.1)
}
mtext(text='Strong leader items', side=3, line=0.4, cex=0.85)
box(lwd=0.75)

# plot 3: only three-statements item
cnt.yr.tab = table(df2[grep('ThreeState', df2$Item), "Year"], 
                   df2[grep('ThreeState', df2$Item), "Country"])
cnt.yr.tab = ifelse(cnt.yr.tab > 0, 1, NA)
plot.dat.2 = rbind(cnt.yr.tab[,plot.cnt.2[1]], cnt.yr.tab[,plot.cnt.2[2]], cnt.yr.tab[,plot.cnt.2[3]],
                   cnt.yr.tab[,plot.cnt.2[4]], cnt.yr.tab[,plot.cnt.2[5]], cnt.yr.tab[,plot.cnt.2[6]],
                   cnt.yr.tab[,plot.cnt.2[7]], cnt.yr.tab[,plot.cnt.2[8]])
plot.dat.2 = plot.dat.2 * 1:8

par(mar=c(2, 7.5, 1.8, 0.5), tcl=-0.2, cex=0.8)
plot(plot.dat.2[1,], type="p", ylim=c(0.5, 8.5), xaxt="n", yaxt="n", xlab="", ylab="", 
     main='', xlim=c(1, 27), bty="n")
abline(h=1:8, col=grey(0.5), lwd=0.75, lty=3)
abline(v=1:28, col=grey(0.5), lwd=0.75, lty=3)
for(i in 1:8){
  points(plot.dat.2[i,], pch=16, cex=1.1)
}
axis(1, at=c(4, 9, 14, 19, 24), labels=c(1995, 2000, 2005, 2010, 2015), cex.axis=0.75, mgp=c(1, 0.1, 0))
axis(2, at=1:8, labels=plot.cnt.2, cex.axis=0.78, mgp=c(1, .5, 0), las=1)
mtext(text='Three statements items', side=3, line=0.4, cex=0.85)
mtext(text='Year', side=1, line=1.1, cex=0.7)
box(lwd=0.75)

# plot 4: only army rule item
cnt.yr.tab = table(df2[grep('Army', df2$Item), "Year"], 
                   df2[grep('Army', df2$Item), "Country"])
cnt.yr.tab = ifelse(cnt.yr.tab > 0, 1, NA)
plot.dat.2 = rbind(cnt.yr.tab[,plot.cnt.2[1]], cnt.yr.tab[,plot.cnt.2[2]], cnt.yr.tab[,plot.cnt.2[3]],
                   cnt.yr.tab[,plot.cnt.2[4]], cnt.yr.tab[,plot.cnt.2[5]], cnt.yr.tab[,plot.cnt.2[6]],
                   cnt.yr.tab[,plot.cnt.2[7]], cnt.yr.tab[,plot.cnt.2[8]])
plot.dat.2 = plot.dat.2 * 1:8

par(mar=c(2, 0.5, 1.8, 0.5), tcl=-0.2, cex=0.8)
plot(plot.dat.2[1,], type="p", ylim=c(0.5, 8.5), xaxt="n", yaxt="n", xlab="", ylab="", 
     main='', xlim=c(1, 27), bty="n")
abline(h=1:8, col=grey(0.5), lwd=0.75, lty=3)
abline(v=1:28, col=grey(0.5), lwd=0.75, lty=3)
for(i in 1:8){
  points(plot.dat.2[i,], pch=16, cex=1.1)
}
axis(1, at=c(4, 9, 14, 19, 24), labels=c(1995, 2000, 2005, 2010, 2015), cex.axis=0.75, mgp=c(1, 0.1, 0))
mtext(text='Military rule items', side=3, line=0.4, cex=0.85)
mtext(text='Year', side=1, line=1.1, cex=0.7)
box(lwd=0.75)

#dev.off()



```





