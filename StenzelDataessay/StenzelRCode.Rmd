---
title: "Evaluating UN peace-keeping Operations"
author: "Tobias Stenzel"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
   - \usepackage{tikz, float, caption}
   - \floatplacement{figure}{H}
   - \interfootnotelinepenalty=10000 # no multi-page footnotes
output:
  bookdown::pdf_document2:
    template: template.tex
    latex_engine: xelatex
    toc: yes
    toc_depth: 2
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
bibliography: bibliography.bib
csl-hanging-indent: yes
fontsize: 12pt 
linestretch: 2.0 # adjust for line spacing 
geometry: left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm
classoption:
- a4paper
- oneside
lang: en-EN
numbersections: yes
csquotes: yes
type: Data Essay for Course
course: Quantitative Methods in Political Science
subtitle: ''
address: ''
email: tobias.stenzel@students.uni-mannheim.de
phone: ''
examiner: Prof. Thomas Gschwend, Ph.D.
chair: ''
mp: 0.55
ID: ''
# STRONGLY BIASED wordcount: '*Wordcount excluding References: `r unima::count_words(knitr::current_input())`*' 
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/american-political-science-association.csl
editor_options:
  markdown:
    wrap: sentence
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      include=FALSE,
                      fig.path = "figs/",
                      out.width="\\textwidth"
                      )

p_needed <- c(# all packages you need to install here
  "knitr",
  "bookdown", # referencing figures and tables by label
  "remotes",
  "ggplot2",
  "stargazer",
  "dplyr", # to compute leads values
  "tidyr", # for dropping nans
  "GGally", # correlation matrix style plots
  "gridExtra", # grid for multiple plots
  "cowplot",
  "MASS", # glm
  "janitor", # fd plot over range
  #"countreg", # rootogram
  "ggeasy", # remove axes
  "latex2exp", # latex legend labels
  "ggridges"
  )


# installs only the required packages 
lapply(p_needed[!(p_needed %in% rownames(installed.packages()))], install.packages)
lapply(p_needed, library, character.only = TRUE)

# separately install for the correct wordcount package 
if (!"unima" %in% rownames(installed.packages())){
  remotes::install_github("vktrsmnv/unima-template", upgrade = "never", dependencies = TRUE)
  }

# this allows you to add notes to figures with a simple chunk option
# you only need to add "notes="text" as a chunk option; 
# the notes will only appear in PDF output
hook_chunk = knit_hooks$get('chunk')
knit_hooks$set(chunk = function(x, options) {
  txt = hook_chunk(x, options)
  # add chunk option 'description' which adds \Description{...} to figures
  if (!is.null(options$notes)) {
    latex_include <- paste0("\\\\vspace\\{0.5cm\\} \\\\\\footnotesize\\{\\\\textit\\{Notes: \\}", options$notes, "\\} \\1")
    gsub('(\\\\end\\{figure\\})', latex_include, txt) 
  } else {
    return(txt)  # pass to default hook
  }
})
if (knitr::is_latex_output()) knitr::knit_hooks$set(plot = knitr::hook_plot_tex)

# This is an option for stargazer tables
# It automatically adapts the output to html or latex,
# depending on whether we want a html or pdf file
stargazer_opt <- ifelse(knitr::is_latex_output(), "latex", "html")

# This ensures that if the file is knitted to HTML,
# significance notes are depicted correctly 
if (stargazer_opt == "html"){
  fargs <- formals(stargazer)
  fargs$notes.append = FALSE
  fargs$notes = c("<em>&#42;p&lt;0.1;&#42;&#42;p&lt;0.05;&#42;&#42;&#42;p&lt;0.01</em>")
  formals(stargazer) <- fargs
}

# only relevant for ggplot2 plotting
# setting a global ggplot theme for the entire document to avoid 
# setting this individually for each plot 
theme_set(theme_classic() + # start with classic theme 
  theme(
    plot.background = element_blank(),# remove all background 
    plot.title.position = "plot", # move the plot title start slightly 
    legend.position = "bottom" # by default, put legend on the bottom
  ))

set.seed(2021)

```
# Empirical Strategy

## Selection of variables

We analyze two hypotheses in this essay. The first hypothesis (H1) is that an increased number of UN troops tends to decrease fatalities of inner-state conflicts. The second hypothesis (H2) is that this effect tends to be more pronounced when conflict parties are willed to settle the conflict.

To test both hypotheses, we need to analyze the interplay of the number of UN peace-keeping troops and the actors' willingness for conflict resolution and its effect on battle-related fatalities. I illustrate the relationships between those variables in Figure 1: *willingness* (M) moderates the effect of *UN forces* (X) on *fatalities* (Y). Furthermore, we have to account for four variables (C) that potentially confound the relationship between our two main independent variables and the outcome variable. 

The first one of these confounders is *rebel strength*. Arguably, a more powerful rebel opposition requires a higher number of UN troops as it has a larger potential to cause fatalities. The second confounder is *number of rebel groups*. A larger number of rebel groups may weaken the opposition due to higher coordination costs. Thus, its effect would have the opposite direction of rebel strength. The third and fourth confounders are whether a *regional* peace-keeping operation (*PKO*) or a state supports the UN mission. Conceivably, both variables reduce the number of required UN troops. However, regional PKO may reduce the number of fatalities, whereas *state intervention* may increase this number because the respective states may have a hidden agenda.

\begin{figure}[H]
\label{fig:causal}
\centering

  \begin{tikzpicture}[node distance={25mm}, thick, main/.style = {draw, circle}]
  
  
  	\node[main] (M) {$M$}; 
  	\node[main] (C) [right of=M] {$C$};
  	\node[main] (Y) [below of=C] {$Y$}; 	
  	\node[main] (X) [below of=M] {$X$}; 
  
  	\draw[->] (X) -- (M); 
  	\draw[->] (X) -- (Y);
  	
  	\draw[->] (C) -- (X);
  	\draw[->] (C) -- (Y);
  	\draw[->] (C) -- (M);
  	
  	\draw[->] (M) -- (Y); 
  \end{tikzpicture}
  
  \caption{Causal relationship between the number of UN peace-keeping forces, actors' willingness to resolve the conflict and battle-related fatalities}

\end{figure}


```{r preprocessing}
#############################################################################################################################################
# Create dataframe where all variables are measured in there real numbers (e.g. not in 1k) and without superfluous variables and observations
#############################################################################################################################################
load("../raw-data/pko.Rdata")

df = pko

# Eliminate critical error in coding: Pop is actually pop in 1k.
df <- df %>% 
  rename(
    pop_1k = pop
    )
df$pop = df$pop_1k * 1000
df$pop_ln <- NULL
df$pop_1k <- NULL

# limit to ongoing conflict
df <- df[df$active_year == 1,]
# delete now constant variables
df$active_year<- NULL
df$peace_24_months <- NULL
df$peace_36_months <- NULL
df$peace_48_months <- NULL

# only use fatalities including civilians and without lag
df$brf_gr <- NULL
df$brf_gr_lag <- NULL
df$brf_grc_lag <- NULL

# compute unlagged troop and police variables and delete lagged vars
df <- df %>%
group_by(conflict_ID) %>%
mutate(un_troop_1k = lead(troop_lag1000, order_by=year_month),
       un_police_1k = lead(police_lag1000, order_by=year_month)
)

df$un_military = df$un_troop_1k * 1000
df$un_police = df$un_police_1k * 1000

# Use for robustness
#df$un_troop_1k <- NULL
#df$un_police_1k <- NULL

df$troop_lag1000 <- NULL
df$police_lag1000 <- NULL

# delete obs if nan in IV
df <- df %>% drop_na(un_military, un_police)

# delete rows containing nans
df <-na.omit(df)

# create IV by adding troops and police
df$un_forces <- df$un_military + df$un_police

# renamings
df <- df %>% 
  rename(
    fatalities = brf_grc
    )

# Show nans left
df[rowSums(is.na(df)) > 0, ]
```

```{r basic stats}
#####################
# compute basic stats
#####################
length(unique(df$conflict_ID))

min(df$year_month)
max(df$year_month)

```

## Data
The dataset contains 3345 monthly observations from 38 active conflicts between 1990 and 2011. The number of UN forces includes both military and police. Fatalities are measured monthly and include civilians and armed forces. Fatalities should be measured relative to the population size. Therefore, we will consider the monthly fatality rate per Mio. inhabitants. Rebel strength is measured in proportion to the government on a scale from one to five. Three represents a level similar to the government. Willingness is measured by whether a ceasefire agreement exists or not. State intervention and regional PKO are binary variables as well.

## Methodology
Since the number of fatalities is an overdispersed count variable, I use negative binomial models. Furthermore, I include population as an offset variable for two reasons: First, as mentioned above, I want to consider the monthly rate of fatalities per population. Second, as pointed out by @agresti2015foundations[^1], using the ratio directly as an independent variable results in biased standard errors. Therefore, it is better to use the denominator variable as an offset. I test several models that gradually include (1) simple additive effects of UN forces and ceasefire, (2) their interaction, and (3) their interaction adjusting for potential confounders. For better comparability of the models, I restrict the data to observations for which the complete set of variables is available. According to hypotheses H1 and H2, we would expect positive effects for UN troops and its interaction with a ceasefire on the fatality rate.

\phantom{This text will be invisible}

\noindent
To illustrate my findings, I simulate expected values for the independent variable fatalities for different scenarios. In this study, I also analyze the interplay between the two main independent variables over the full range of UN troops to inspect the shape of this relation.[^2]

[^1]: See page 233.
[^2]: Note that expected values underestimate the total uncertainty because they do only include the estimation uncertainty but not the fundamental uncertainty.

# Descriptive Statistics

```{r df-with-counts-divided-by-pop}
###########################################################
# create dataframe with armed forces relative to polulation
###########################################################
df_pop <- df

df_pop$un_forces_pop <- df_pop$un_forces / df_pop$pop
df_pop$un_police_pop <- df_pop$un_police / df_pop$pop
df_pop$un_military_pop <- df_pop$un_military / df_pop$pop
df_pop$fatalities_pop <- df_pop$fatalities / df_pop$pop

# check validity: ratios shoud be smaller 1
df_pop[df_pop$un_forces_pop > 1, ]
df_pop[df_pop$fatalities_pop > 1, ]
```


```{r desc-stats-main-vars}
#############################################
# Prepare data for plots on descriptive stats
#############################################

#find useful population and force count units for illustration
df_pop$un_forces_1k = df_pop$un_forces / 1000

df_pop$un_forces_pop_mio = df_pop$un_forces / (df_pop$pop / 1000 /1000)
df_pop$fatalities_pop_mio = df_pop$fatalities / (df_pop$pop /1000 /1000)

# get upper quantiles
quant_fat <- quantile(df_pop$fatalities_pop_mio, c(.95, .975, .99)) 
quant_forces <-quantile(df_pop$un_forces_1k, c(.95, .975, .99)) 

# create plot dataframe with categorical variables for better figures
df_pop_categorical <- df_pop
df_pop_categorical$ceasefire <- as.factor(df_pop$ceasefire)

# Without outliers
#df_pop_categorical[df_pop$fatalities_pop_mio > quant_fat[1], ]
#df_pop_categorical[df_pop$un_forces_pop_mio > quant_forces[1], ]
#df_pop_categorical <-df_pop_categorical[!(df_pop_categorical$fatalities_pop_mio > quant_fat[1] | df_pop_categorical$un_forces_pop_mio > quant_forces[1]),]

plot_data <-df_pop_categorical[c("fatalities_pop_mio","un_forces_1k","ceasefire")]

df_pop[which.max(df_pop$fatalities_pop_mio),]
df_pop[which.max(df_pop$un_forces_1k),]
mean(df_pop$fatalities_pop_mio)
sd(df_pop$fatalities_pop_mio)
mean(df_pop$un_forces_1k)
sd(df_pop$un_forces_1k)
mean(df_pop$ceasefire)
```

In this section, we take a closer look at the distributions of our variables. This will help us distinguish typical and unusual values or events and improve our intuition about their relations. Moreover, we can use our insights to select interesting scenarios for analyzing the substantial effects of our main variables.

\phantom{This text will be invisible}

```{r plot, label="desc-main", include=TRUE, echo=FALSE, fig.cap="Distribution and relationships of main variables.", notes="Fatalities/Mio. pop. are monthly.", message=FALSE, fig.pos="H"}
##################################
# Plot descriptive stats main vars
##################################´
ggpairs(plot_data, title="", columnLabels=c("Fatalities/Mio. pop.", "UN Forces in 1k","Ceasefire"))

#df_pop[which.max(df_pop$fatalities_pop_mio),]
```

\noindent
Figure \@ref(fig:desc-main) shows the distributions of our main variables. The first column depicts the monthly rate of fatalities per million inhabitants. It has mean 5.2 and standard deviation 67. We see that it approximately follows the power law. This means that most of the values are very low, i.e., close to 0, but the distribution has a long tail. Accurately modeling the latter property is challenging because most distribution cannot account for non-zero probabilities for very extreme events. We also observe an extreme outlier: In June 1997, 9793 people were killed in the conflict between the state of Congo and the rebel group Cobras. As extreme values are arguably a defining property of this DGP, such outliers should not be removed. The second row shows that the most extreme fatality rates did not occur in the presence of substantial UN forces. 

\noindent
The second column depicts the distribution of UN forces. Its mean and standard deviation are 1.1 and 4.0, respectively. This count distribution has a similar shape to the previous with less pronounced extremes. The highest number of UN forces was counted in 1993 in Somalia as 29,209. This variable is almost uncorrelated with fatalities.
The third column shows the binary distribution of ceasefire. We see a ceasefire agreement in 19% of the observations. However, if there is an agreement, UN forces tend to be larger.

\noindent
Figure \@ref(fig:desc-conf) presents the distributions of our controls. Light gray depicts the contributions from observations with a ceasefire and dark grey without a ceasefire. We observe that rebel groups, in most cases, are weaker than the government. However, with increasing strength, the frequency of ceasefire agreements also increases. The same two trends are also true for the number of rebel groups. In some cases, the number is surprisingly high. Finally, the distribution of state intervention and regional PKO is almost identical. The two events have a frequency of 16% and 17%, respectively. However, the correlation between both variables is only about 7%. Therefore, it appears as if their roles are somewhat similar and that both events tend to substitute each other. 

\phantom{This text will be invisible}


```{r desc-stats-confounders, label="desc-conf", include=TRUE, echo=FALSE, fig.cap="Distribution of potential confounders.", warning=FALSE, fig.pos="H"}
####################################
# Plot descriptive stats confounders
####################################

# Stacked barplot with multiple groups
p1 <- ggplot(data=df_pop_categorical, aes(x=as.factor(rebel_strength), fill=ceasefire)) + xlab("Rebel Strength") +
  geom_bar(stat="count") + scale_fill_grey() + easy_remove_x_axis(what = c("line", "ticks"), teach = FALSE)

p2 <- ggplot(data=df_pop_categorical, aes(x=as.factor(n_rebel_groups), fill=ceasefire)) + xlab("Number of Rebel Groups") +
  geom_bar(stat="count") + scale_fill_grey() + easy_remove_x_axis(what = c("line", "ticks"), teach = FALSE)

p3 <- ggplot(data=df_pop_categorical, aes(x=as.factor(biased_intervention), fill=ceasefire)) + xlab("State Intervention") + geom_bar(stat="count") + scale_fill_grey() + easy_remove_x_axis(what = c("line", "ticks"), teach = FALSE)

p4 <- ggplot(data=df_pop_categorical, aes(x=as.factor(regional_pko), fill=ceasefire, fill = Type.id)) + xlab("Regional PKO") +
geom_bar(stat="count") + scale_fill_grey() + easy_remove_x_axis(what = c("line", "ticks"), teach = FALSE)

# arrange the three plots in a single row
prow <- plot_grid( p1 + theme(legend.position="none"),
           p2 + theme(legend.position="none"),
           p3 + theme(legend.position="none"),
          p4 + theme(legend.position="none"),
           align = 'vh',
           #labels = c("A", "B", "C"),
           hjust = -1,
           nrow = 2
           )
# extract the legend from one of the plots
# (clearly the whole thing only makes sense if all plots
# have the same legend, so we can arbitrarily pick one.)
legend_b <- get_legend(p1 + theme(legend.position="bottom"))

# add the legend underneath the row we made earlier. Give it 10% of the height
# of one plot (via rel_heights).
p <- plot_grid( prow, legend_b, ncol = 1, rel_heights = c(1, .2))
p
```

```{r small-calc-corr}
cor(df_pop_categorical$biased_intervention, df_pop_categorical$regional_pko)
mean(df_pop_categorical$biased_intervention)
mean(df_pop_categorical$regional_pko)
```

# Results

## Regression Results

Table \@ref(tab:table) shows the results of the negative binomial regression analyses for H1 and H2. Model (1) shows purely additive effects. For a typical observation with reference-level variable values, the intercept equals the log fatality rate, i.e., the number of monthly fatalities per Mio. inhabitants. The coefficients show how much a one-unit increase in the respective covariate increases the log of the fatality rate. This results in the following interpretations: In model (1), the reference fatality rate is 4.92. If a thousand UN forces were deployed, the rate would have decreased by 11.% (or the log would have decreased by 0.122). This finding agrees with H1. However, if the parties had agreed to a ceasefire, the rate would have increased by 157%. Model (2) adds the interaction effect between both dependent variables. It has the following interpretation: If there is a ceasefire, an increase in UN forces by 1k results in an increase of monthly fatalities per mio inhabitants by 102%. This result contradicts H2. Model (3), however, tests whether these findings are robust to the four confounders. We can see that the direction of the interaction effect changes from model (2) to model (3) into the direction suggested by H2. The effects of UN forces, ceasefire and their interaction on fatalities are now -17%, +132%, and -8%, respectively. Moreover, the effects of our controls rebel strength, number of rebel groups, state intervention, and regional PKO are +214%, -4%, +271%, and -45%. We interpret variables separately, holding all others constant at their reference values. According to all measures of goodness of fit, the best model is model (3). There, all coefficients except the number of rebel groups are highly significant.

```{r negative-binomial-model}
# control=glm.control(maxit=100) increases the number of maximum iterations
# increase it when you see the warning: "glm.fit: algorithm did not converge"
df_glm <- df


df_glm$pop_mio <- df_glm$pop / 1000 / 1000

df_glm$un_forces_1k <- df_glm$un_forces / 1000

df_glm$interaction = df_glm$un_forces_1k * df_glm$ceasefire

m1_nb <- glm.nb(
  fatalities ~ un_forces_1k + ceasefire  + offset(log(pop_mio)),
  data = df_glm,
  control = glm.control(maxit = 100),

)
summary(m1_nb)

m2_nb <- glm.nb(
  fatalities ~ un_forces_1k + ceasefire + interaction + offset(log(pop_mio)),
  data = df_glm,
  control = glm.control(maxit = 300),

)
summary(m2_nb)

m3_nb <- glm.nb(
  fatalities ~ un_forces_1k + ceasefire
  + rebel_strength + n_rebel_groups + biased_intervention + regional_pko + interaction + offset(log(pop_mio)),
  data = df_glm,
  control = glm.control(maxit = 100),

)
summary(m3_nb)
```

## Model Fit 

As mentioned in the methodology section, I use the likelihood ratio test to decide whether I can use the simpler Poisson model instead. Nevertheless, the tests suggest the negative binomial model for all models due to overdispersion. However, to decide which specific model specification is best, I consider the Akaike information criterion (AIC). The intuition is that a higher model likelihood can also be solely because more covariates are included. Therefore, the AIC penalizes the number of model variables. Unsurprisingly, model (3) has the best fit according to the AIC. Another interesting fact is that model (2) with the interaction term is worse than baseline model (1).

```{r likelihood-ratio-test-overdispersion}
m1_p <- glm(
  fatalities ~ un_forces_1k + ceasefire  + offset(log(pop_mio)),
  data = df_glm,
  family = "poisson"
)
m2_p <- glm(
  fatalities ~ un_forces_1k + ceasefire + interaction + offset(log(pop_mio)),
  data = df_glm,
  family = "poisson"
)
m3_p <- glm(
  fatalities ~ un_forces_1k + ceasefire
  + rebel_strength + n_rebel_groups + biased_intervention + regional_pko + interaction + offset(log(pop_mio)),
  data = df_glm,
  family = "poisson"
)
nbinomials <- list(m1_nb, m2_nb, m3_nb)
poissons <- list(m1_p, m2_p, m3_p)

for (i in 1:length(nbinomials)) {
  # control=glm.control(maxit=100) increases the number of maximum iterations
  # increase it when you see the warning: "glm.fit: algorithm did not converge"
  
  # Likelihood Ratio Test
  L1 <- logLik(poissons[[i]]) # Log Likelihood of model 1
  L2 <- logLik(nbinomials[[i]]) # Log Likelihood of model 2
  
  LRT <- -2 * L1 + 2 * L2 # converges to chi^2 distribution
  
  # Reject H0 if ... What is our H0 here?
  print(LRT > qchisq(0.95, df = 1)) # why df = 1?
}

# Takes too much time and kills the kernel...

#rootogram(m3_p, main = "Poisson Model") 
#rootogram(m3_nb, main = "Negative Binomial Model") 
```

```{r table, label="table", results='asis', include=TRUE, echo=FALSE}
stargazer(
  list(m1_nb, m2_nb, m3_nb),
  out = "table_lab.tex",
  title = "Regression Results",
  notes = "",
  intercept.bottom = TRUE,
  covariate.labels = c(
    "UN Forces in 1k",
    "Ceasefire",
    "Rebel Strength",
    "Number Rebel Groups",
    "Biased Intervention",
    "Regional PKO",
    "UN Forces * Ceasefire",
    "Constant"
  ),
  label = paste0("tab:", knitr::opts_current$get("label")),
  dep.var.labels = c("Monthly fatalities / pop. in Mio."),
  #table.placement = "H", # latex output, keep the figure at exactly Here in text
  type = stargazer_opt,
  header=FALSE
)
```

## Simulation of Expected Rates

```{r simulation-exp-probs}

nsim <- 1000

# 1. get the coefficients
gamma_hat <- coef(m3_nb)

# 2. Get the variance-covariance matrix
V_hat <- vcov(m3_nb)

# 3. Set up a multivariate normal distribution N(gamma_hat, V_hat)
# 4. Draw from the distribution nsim times
S <- mvrnorm(nsim, gamma_hat, V_hat)

names(gamma_hat)

scenario_0forces0ceasefire <- cbind(
  1, # intercept
  0, # un_forces
  0, # ceasefire
  mean(df_glm$rebel_strength),
  mean(df_glm$n_rebel_groups),
  median(df_glm$biased_intervention),
  median(df_glm$regional_pko),
  0 # interaction
)

scenario_1forces0ceasefire <- scenario_0forces0ceasefire
df_1un_forces <- df_glm[df_glm["un_forces_1k"] != 0,]
scenario_1forces0ceasefire[2] <- mean(df_1un_forces[["un_forces_1k"]])
mean(df_1un_forces[["un_forces_1k"]])

quant_1forces <- quantile(df_1un_forces[["un_forces_1k"]],  probs = 0.9)
quant_1forces[[1]]
scenario_2forces0ceasefire <- scenario_1forces0ceasefire
scenario_2forces0ceasefire[2] <- quant_1forces[[1]]


scenario_1forces1ceasefire <- scenario_1forces0ceasefire
scenario_1forces1ceasefire[3] = 1
scenario_1forces1ceasefire[8] = mean(df_1un_forces[["un_forces_1k"]]) # interaction gets mean forces if deployed

# Calculate the linear predictor:
Xbeta_0forces0ceasefire <- S %*% t(scenario_0forces0ceasefire)
Xbeta_1forces0ceasefire <- S %*% t(scenario_1forces0ceasefire)
Xbeta_2forces0ceasefire <- S %*% t(scenario_2forces0ceasefire)
Xbeta_1forces1ceasefire <- S %*% t(scenario_1forces1ceasefire)


#To get expected values for lambda, we need to plug in the `Xbeta` values into the response function.
lambda_0forces0ceasefire <- exp(Xbeta_0forces0ceasefire)
lambda_1forces0ceasefire <- exp(Xbeta_1forces0ceasefire)
lambda_2forces0ceasefire <- exp(Xbeta_2forces0ceasefire)
lambda_1forces1ceasefire <- exp(Xbeta_1forces1ceasefire)

# Get the theta
theta <- m3_nb$theta

exp_0forces0ceasefire <-
  sapply(lambda_0forces0ceasefire, function(x)
    mean(rnbinom(1000, size = theta, mu = x)))
exp_1forces0ceasefire <-
  sapply(lambda_1forces0ceasefire, function(x)
    mean(rnbinom(1000, size = theta, mu = x)))
exp_2forces0ceasefire <-
  sapply(lambda_2forces0ceasefire, function(x)
    mean(rnbinom(1000, size = theta, mu = x)))
exp_1forces1ceasefire <-
  sapply(lambda_1forces1ceasefire, function(x)
    mean(rnbinom(1000, size = theta, mu = x)))


# Compute QoIs for German pop of 83 mio
exp_0forces0ceasefire_ger <- exp_0forces0ceasefire * 83
exp_1forces0ceasefire_ger  <- exp_1forces0ceasefire * 83
exp_2forces0ceasefire_ger  <- exp_2forces0ceasefire * 83
exp_1forces1ceasefire_ger  <- exp_1forces1ceasefire * 83

summary(exp_0forces0ceasefire_ger)
#summary(as.vector(lambda_0forces0ceasefire)) # as.vector ensures the horizontal summary output 
summary(exp_1forces0ceasefire_ger)

#summary(as.vector(lambda_1forces1ceasefire)) # as.vector ensures the horizontal summary output 
summary(exp_1forces1ceasefire_ger)
summary(exp_2forces0ceasefire_ger)
mean(df_1un_forces[["un_forces_1k"]])
quantile(df_1un_forces[["un_forces_1k"]],  probs = 0.9)
```

For a substantial interpretation of the regression results from model (3), I simulate the expected fatality rate for four scenarios. In each scenario, I use monthly fatalities per 83 Mio. inhabitants. This denominator helps to set the number in proportion to the German population. The scenarios use different values for both main explaining variables. I depict the results in Figure \@ref(fig:scenarios). Scenario 1 assumes zero UN forces and no ceasefire. This results in roughly 230 fatalities per month. The second scenario sets the number of UN forces to the mean of the deployed forces if forces were deployed at all. The expected rate for this case is much lower with 145 fatalities. Next, I also assume ceasefire. Although the first-order effect is positive, the total effect should be negative regarding the activated interaction term with UN forces. Accordingly, the fatality rate increases compared to the previous result by 32 fatalities per month. Finally, I assume that there is no ceasefire but that the number of UN forces is at its 90th percentile value of observations with deployed forces, i.e., 21.527. This scenario achieves the lowest rate by far with only 49 monthly fatalities. It shows that the first-order effect of the number of UN troops is much more critical than its interaction with a ceasefire. Additionally, we observe that standard errors are relatively small for the last scenario. This comes from the fact that the number of counts is closer to the zero bound.


```{r scenarios, label="scenarios", include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Expected monthly fatalities / 82 Mio. inhabitants", notes="UN 1 and 2 corresponds to mean and 90th percentile values of UN forces if deployed"}
# monthly and per 1k pop.
df_plot <- data.frame(exp_values = c(exp_2forces0ceasefire_ger, exp_1forces1ceasefire_ger, exp_1forces0ceasefire_ger, exp_0forces0ceasefire_ger),
id = factor(
                   rep(c("UN 2, Ceasefire 0", "UN 1, Ceasefire 1", "UN 1, Ceasefire 0", "UN 0, Ceasefire 0"), each = 1000),
                   levels = c("UN 2, Ceasefire 0", "UN 1, Ceasefire 1", "UN 1, Ceasefire 0", "UN 0, Ceasefire 0")
                 ))


# or another very nice way to avoid overlapping (often happens when groups > 3)
ggplot(df_plot, aes(x = exp_values, y = id, fill = id))  + scale_fill_grey() + #+scale_fill_grey(limits=c("un", "un + cease"))
 
  ggridges::geom_density_ridges(alpha = 0.7) + #xlim(0,66) + 
  xlab("Expected Killings") +
  ylab("") +
  #scale_fill_viridis_d() +
  coord_cartesian(clip = "off") +
  scale_y_discrete(expand = c(0, 0)) +
  ggridges::theme_ridges(grid = FALSE, center_axis_labels = TRUE) +
  theme(legend.position = "none",
        plot.title.position = "plot") +
  labs(x = "Monthly Fatalities / 83. Mio",
       y = "",
       title = "",
       subtitle = "",
       caption = "") 
```
## First Differences

```{r first-difference-11vs10-given-whole-un_forces-range}
# create sequence for the continuous variable 
seq_un_forces_1k <- round(seq(
  min(m2_nb$model$un_forces_1k), 
  quantile(m2_nb$model$un_forces_1k, 1.), # why not max?
  length.out = 100
))

matrix_scenario_1forces0ceasefire <- cbind(
  1, # intercept
  seq_un_forces_1k, # un_forces
  0, # ceasefire
  mean(df_glm$rebel_strength),
  mean(df_glm$n_rebel_groups),
  median(df_glm$biased_intervention),
  median(df_glm$regional_pko),
  0 # interaction
)

matrix_scenario_1forces1ceasefire <- cbind(
  1, # intercept
  seq_un_forces_1k, # un_forces
  1, # ceasefire
  mean(df_glm$rebel_strength),
  mean(df_glm$n_rebel_groups),
  median(df_glm$biased_intervention),
  median(df_glm$regional_pko),
  seq_un_forces_1k # interaction
)

colnames(matrix_scenario_1forces0ceasefire) <- names(gamma_hat)
head(matrix_scenario_1forces0ceasefire)

Xbeta10 <- S %*% t(matrix_scenario_1forces0ceasefire )
Xbeta11 <- S %*% t(matrix_scenario_1forces1ceasefire )
lambda10 <- exp(Xbeta10)
lambda11 <- exp(Xbeta11)

exp_10 <-
  apply(lambda10, c(1, 2), function(x)
    mean(rnbinom(100, size = theta, mu = x)))

exp_11 <-
  apply(lambda11, c(1, 2), function(x)
    mean(rnbinom(100, size = theta, mu = x)))

exp_10_ger <- exp_10 * 800

exp_11_ger <- exp_11 * 800

FD_ger <- exp_10_ger - exp_11_ger

quants_10_ger <- t(apply(exp_10_ger, 2, quantile, c(0.025, 0.5, 0.975)))
quants_11_ger <- t(apply(exp_11_ger, 2, quantile, c(0.025, 0.5, 0.975)))
quants_fd_ger <- t(apply(FD_ger , 2, quantile, c(0.025, 0.5, 0.975)))
colnames(quants_10_ger)
```

For a conclusion of H1 and H2, I simulate the expected effect of UN forces with ceasefire equals 0 and equals 1. Depicting the whole range allows us to observe potential non-linearity in the relationship between our main explaining variables regarding their impact on fatalities. To emphasize the difference between both scenarios, I also compute the first difference between both. Figure \@ref(fig:plot-fd) shows the results. The light gray line depicts the expected fatality rate with a ceasefire, the dark gray line without a ceasefire, and the red line represents the first difference. We make the following observations: First, the direction of the impact of ceasefire changes between operations with only a few and operations with many UN forces. This finding corresponds to H2, i.e. a large number of UN forces is more effective if there is a ceasefire. Second, the uncertainty does also decrease with the stronger UN forces. The reason is that the number of conflicts decreases with the number of forces. Therefore, many of the observations tend to be from the same conflict and thus very similar. We can regard this as a drawback of my approach.

```{r plot-first-difference, label="plot-fd", include=TRUE, echo=FALSE, fig.cap="The effect of ceasefire over the whole range of UN troops", notes="$X_1$ and $X_2$ correspond to UN Forces and Ceasefire, respectively. First Difference is $E(Y|X_2=1,X_1) - E(Y|X_2=0,X_1)$."}
# E(Y|X_2=0,X1)
quants <- as.data.frame(rbind(quants_10_ger , quants_11_ger, quants_fd_ger))
quants$regime <- rep(c("10","11","11-10"), each = 100)
quants$seq_un_forces_1k <- rep(seq_un_forces_1k, times = 3)
quants <- clean_names(quants) # easier-to-work names

ggplot(data = quants, 
       mapping = aes(x = seq_un_forces_1k, y = x50_percent, group = regime)) + scale_color_manual(values=c("#808080", "#b8b3b4", "#e9645f"),
                                                                                                  labels=unname(TeX(c("$E(Y|X_2=0,X_1)", "$E(Y|X_2=1,X_1)", "First Difference")))) +  
  geom_pointrange(aes(ymin = x2_5_percent, ymax = x97_5_percent, color = regime), alpha = 0.5) +
  #scale_color_viridis_d() +
  labs(x = "UN forces in 1k",
       y = "Monthly Fatalities / 83 Mio. Inhabitants",
       color = "",
       title = "",
       subtitle = "",
       caption = "") +
  theme(legend.position = c(0.9, 0.9)) + geom_hline(yintercept=0)

```

# Robustness Checks

To assess the robustness of my findings towards outliers, I recompute model (3) from the set of observations with standardized deviance residuals greater than 2. Both specifications are relatively close. I also test two alternative variants of the main explaining variable UN forces. For this purpose, I decompose UN forces into police and military officers. Then, I recompute model (3) twice again with one of these variables as a substitute for the total number of forces. Again, the coefficients do not change much, although military units appear more effective without a ceasefire, whereas police forces have a higher interaction coefficient.

```{r robust-towars-outliers-and-IV-changes, collapse=FALSE}
summary(m3_nb)
# remove outliers 
robust_m3_nb<- glm.nb(formula = fatalities ~ un_forces_1k + ceasefire
  + rebel_strength + n_rebel_groups + biased_intervention + regional_pko + interaction #+ offset(log(pop_mio)),
  ,data = m3_nb$model[!rstandard(m3_nb) > 2,], control = glm.control(maxit = 200)
    )
summary(robust_m3_nb)

m3_nb_military <- glm.nb(
  fatalities ~ un_troop_1k + ceasefire
  + rebel_strength + n_rebel_groups + biased_intervention + regional_pko + interaction + offset(log(pop_mio)),
  data = df_glm,
  control = glm.control(maxit = 100)

)
summary(m3_nb_military)

m3_nb_police <- glm.nb(
  fatalities ~ un_police_1k + ceasefire
  + rebel_strength + n_rebel_groups + biased_intervention + regional_pko + interaction + offset(log(pop_mio)),
  data = df_glm,
  control = glm.control(maxit = 100)
)
summary(m3_nb_police)
```

# Conclusion

In this essay, I analyze two hypotheses. First, whether an increased number of UN troops tends to decrease fatalities of inner-state conflicts. And second, whether this effect tends to be more pronounced when conflict parties are willed to settle the conflict. I found convincing evidence for both hypotheses using a negative binomial model that includes an interaction term and a set of potential confounders. However, this study has the following limitations. First, the number of variables is relatively small. Second, the model assumption that $Y_1, \dots , Y_n$ are independent appears too strong for panel data. These issues can be addressed by future research.
\newpage

# References {.unnumbered}

\singlespacing

::: {#refs}
:::


\clearpage

# Statutory Declaration {.unnumbered}

Hiermit versichere ich, dass diese Arbeit von mir persönlich verfasst ist und dass ich keinerlei fremde Hilfe in Anspruch genommen habe.
Ebenso versichere ich, dass diese Arbeit oder Teile daraus weder von mir selbst noch von anderen als Leistungsnachweise andernorts eingereicht wurden.
Wörtliche oder sinngemäße Übernahmen aus anderen Schriften und Veröffentlichungen in gedruckter oder elektronischer Form sind gekennzeichnet.
Sämtliche Sekundärliteratur und sonstige Quellen sind nachgewiesen und in der Bibliographie aufgeführt.
Das Gleiche gilt für graphische Darstellungen und Bilder sowie für alle Internet-Quellen.
Ich bin ferner damit einverstanden, dass meine Arbeit zum Zwecke eines Plagiatsabgleichs in elektronischer Form anonymisiert versendet und gespeichert werden kann.
Mir ist bekannt, dass von der Korrektur der Arbeit abgesehen werden kann, wenn die Erklärung nicht erteilt wird.

```{=tex}
\SignatureAndDate{}
\renewcommand*{\thepage}{ }
```
\noindent I hereby declare that the paper presented is my own work and that I have not called upon the help of a third party.
In addition, I affirm that neither I nor anybody else has submitted this paper or parts of it to obtain credits elsewhere before.
I have clearly marked and acknowledged all quotations or references that have been taken from the works of other.
All secondary literature and other sources are marked and listed in the bibliography.
The same applies to all charts, diagrams and illustrations as well as to all Internet sources.
Moreover, I consent to my paper being electronically stores and sent anonymously in order to be checked for plagiarism.
I am aware that the paper cannot be evaluated and may be graded "failed" ("nicht ausreichend") if the declaration is not made.

\SignatureAndDateEng{}

<!-- Line below depicts the content that should not be counted in the wordcount -->
<!---TC:ignore--->
